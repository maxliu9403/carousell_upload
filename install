#!/bin/bash
# =============================================================================
# Carousell Uploader - é€šç”¨å®‰è£…è„šæœ¬
# =============================================================================
# è‡ªåŠ¨æ£€æµ‹æ“ä½œç³»ç»Ÿå¹¶è°ƒç”¨ç›¸åº”çš„å®‰è£…è„šæœ¬
# æ”¯æŒç³»ç»Ÿ: Windows, macOS, Linux
# ç‰ˆæœ¬: 2.0.0
# ä½œè€…: Carousell Uploader Team
# =============================================================================

set -e

# =============================================================================
# å…¨å±€é…ç½®
# =============================================================================
SCRIPT_VERSION="2.0.0"
PROJECT_NAME="Carousell Uploader"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# =============================================================================
# å·¥å…·å‡½æ•°
# =============================================================================

print_header() {
    echo -e "${WHITE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${WHITE}â•‘${NC} ${CYAN}ğŸš€ $PROJECT_NAME é€šç”¨å®‰è£…è„šæœ¬ v$SCRIPT_VERSION${NC} ${WHITE}â•‘${NC}"
    echo -e "${WHITE}â•‘${NC} ${CYAN}æ”¯æŒç³»ç»Ÿ: Windows, macOS, Linux${NC} ${WHITE}â•‘${NC}"
    echo -e "${WHITE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_step() {
    echo -e "${PURPLE}ğŸ”§ $1${NC}"
}

# æ£€æµ‹æ“ä½œç³»ç»Ÿ
detect_os() {
    print_step "æ£€æµ‹æ“ä½œç³»ç»Ÿ..."
    
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        OS="linux"
        print_success "æ£€æµ‹åˆ°Linuxç³»ç»Ÿ"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        OS="macos"
        print_success "æ£€æµ‹åˆ°macOSç³»ç»Ÿ"
    elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]] || [[ "$OSTYPE" == "win32" ]]; then
        OS="windows"
        print_success "æ£€æµ‹åˆ°Windowsç³»ç»Ÿ"
    else
        print_error "ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $OSTYPE"
        print_info "æ”¯æŒçš„ç³»ç»Ÿ: Linux, macOS, Windows (Git Bash/WSL)"
        exit 1
    fi
}

# æ£€æŸ¥å®‰è£…è„šæœ¬
check_install_scripts() {
    print_step "æ£€æŸ¥å®‰è£…è„šæœ¬..."
    
    case "$OS" in
        "linux"|"macos")
            if [ -f "install.sh" ]; then
                print_success "æ‰¾åˆ°Linux/macOSå®‰è£…è„šæœ¬: install.sh"
                INSTALL_SCRIPT="install.sh"
            else
                print_error "æœªæ‰¾åˆ°install.shè„šæœ¬"
                exit 1
            fi
            ;;
        "windows")
            # æ£€æŸ¥PowerShellè„šæœ¬
            if [ -f "install.ps1" ]; then
                print_success "æ‰¾åˆ°PowerShellå®‰è£…è„šæœ¬: install.ps1"
                INSTALL_SCRIPT="install.ps1"
            # æ£€æŸ¥æ‰¹å¤„ç†è„šæœ¬
            elif [ -f "install.bat" ]; then
                print_success "æ‰¾åˆ°æ‰¹å¤„ç†å®‰è£…è„šæœ¬: install.bat"
                INSTALL_SCRIPT="install.bat"
            else
                print_error "æœªæ‰¾åˆ°Windowså®‰è£…è„šæœ¬"
                exit 1
            fi
            ;;
    esac
}

# æ‰§è¡Œå®‰è£…è„šæœ¬
run_install_script() {
    print_step "æ‰§è¡Œå®‰è£…è„šæœ¬..."
    
    case "$OS" in
        "linux"|"macos")
            print_info "æ‰§è¡ŒLinux/macOSå®‰è£…è„šæœ¬..."
            chmod +x "$INSTALL_SCRIPT"
            ./"$INSTALL_SCRIPT"
            ;;
        "windows")
            if [[ "$INSTALL_SCRIPT" == "install.ps1" ]]; then
                print_info "æ‰§è¡ŒPowerShellå®‰è£…è„šæœ¬..."
                # æ£€æŸ¥PowerShellæ‰§è¡Œç­–ç•¥
                if ! powershell -Command "Get-ExecutionPolicy" | grep -q "Restricted"; then
                    powershell -ExecutionPolicy Bypass -File "$INSTALL_SCRIPT"
                else
                    print_warning "PowerShellæ‰§è¡Œç­–ç•¥å—é™ï¼Œå°è¯•å…¶ä»–æ–¹å¼..."
                    # å°è¯•ä½¿ç”¨æ‰¹å¤„ç†è„šæœ¬
                    if [ -f "install.bat" ]; then
                        print_info "ä½¿ç”¨æ‰¹å¤„ç†è„šæœ¬å®‰è£…..."
                        ./install.bat
                    else
                        print_error "æ— æ³•æ‰§è¡ŒPowerShellè„šæœ¬ï¼Œè¯·æ‰‹åŠ¨è¿è¡Œ:"
                        print_info "  powershell -ExecutionPolicy Bypass -File install.ps1"
                        exit 1
                    fi
                fi
            elif [[ "$INSTALL_SCRIPT" == "install.bat" ]]; then
                print_info "æ‰§è¡Œæ‰¹å¤„ç†å®‰è£…è„šæœ¬..."
                ./"$INSTALL_SCRIPT"
            fi
            ;;
    esac
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_usage() {
    echo ""
    print_success "ğŸ‰ å®‰è£…å®Œæˆï¼"
    echo ""
    print_info "ğŸ“ é¡¹ç›®ç›®å½•: $(pwd)"
    print_info "ğŸ è™šæ‹Ÿç¯å¢ƒ: $(pwd)/venv"
    print_info "âš™ï¸  é…ç½®æ–‡ä»¶: $(pwd)/config/settings.yaml"
    echo ""
    
    print_info "ğŸš€ å¿«é€Ÿä½¿ç”¨:"
    echo ""
    
    case "$OS" in
        "windows")
            echo "1. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ:"
            echo "   cd $(pwd)"
            echo "   .\\activate_env.bat"
            echo ""
            echo "2. æˆ–ç›´æ¥è¿è¡Œ:"
            echo "   cd $(pwd)"
            echo "   .\\run.bat"
            echo ""
            echo "3. é…ç½®è®¾ç½®:"
            echo "   notepad $(pwd)\\config\\settings.yaml"
            ;;
        *)
            echo "1. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ:"
            echo "   cd $(pwd)"
            echo "   source ./activate_env.sh"
            echo ""
            echo "2. æˆ–ç›´æ¥è¿è¡Œ:"
            echo "   cd $(pwd)"
            echo "   ./run.sh"
            echo ""
            echo "3. é…ç½®è®¾ç½®:"
            echo "   nano $(pwd)/config/settings.yaml"
            ;;
    esac
    
    echo ""
    print_info "ğŸ“š æ›´å¤šä¿¡æ¯:"
    echo "- é¡¹ç›®æ–‡æ¡£: README.md"
    echo "- é…ç½®è¯´æ˜: config/settings.example.yaml"
    echo "- é—®é¢˜åé¦ˆ: https://github.com/maxliu9403/carousell_upload/issues"
    echo ""
    print_success "å®‰è£…å®Œæˆï¼å¼€å§‹ä½¿ç”¨ Carousell Uploader å§ï¼"
}

# ä¸»å‡½æ•°
main() {
    print_header
    
    # æ£€æµ‹æ“ä½œç³»ç»Ÿ
    detect_os
    
    # æ£€æŸ¥å®‰è£…è„šæœ¬
    check_install_scripts
    
    # æ‰§è¡Œå®‰è£…è„šæœ¬
    run_install_script
    
    # æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
    show_usage
}

# é”™è¯¯å¤„ç†
trap 'print_error "å®‰è£…è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°è¾“å‡ºä¿¡æ¯"; exit 1' ERR

# è¿è¡Œä¸»å‡½æ•°
main "$@"

