name: Build Windows Executable

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode'
        required: true
        default: 'onefile'
        type: choice
        options:
        - onefile
        - onedir

permissions:
  contents: write
  pull-requests: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        playwright install chromium
    
    - name: Build executable (onefile)
      if: github.event.inputs.build_mode == 'onefile' || github.event.inputs.build_mode == '' || github.event.inputs.build_mode == null
      run: |
        pyinstaller --onefile --console --name=CarousellUploader --add-data="config;config" --add-data="uploader/regions;uploader/regions" --add-data="data;data" --hidden-import=playwright --hidden-import=pyautogui --hidden-import=pyperclip --hidden-import=openpyxl --hidden-import=pandas --hidden-import=yaml --hidden-import=requests --hidden-import=PIL --hidden-import=selenium --hidden-import=webdriver_manager cli/main.py
    
    - name: Build executable (onedir)
      if: github.event.inputs.build_mode == 'onedir'
      run: |
        pyinstaller --onedir --console --name=CarousellUploader --add-data="config;config" --add-data="uploader/regions;uploader/regions" --add-data="data;data" --hidden-import=playwright --hidden-import=pyautogui --hidden-import=pyperclip --hidden-import=openpyxl --hidden-import=pandas --hidden-import=yaml --hidden-import=requests --hidden-import=PIL --hidden-import=selenium --hidden-import=webdriver_manager cli/main.py
    
    - name: Upload onefile artifact
      if: github.event.inputs.build_mode == 'onefile' || github.event.inputs.build_mode == '' || github.event.inputs.build_mode == null
      uses: actions/upload-artifact@v4
      with:
        name: CarousellUploader-Windows-onefile
        path: dist/CarousellUploader.exe
        retention-days: 30
    
    - name: Upload onedir artifact
      if: github.event.inputs.build_mode == 'onedir'
      uses: actions/upload-artifact@v4
      with:
        name: CarousellUploader-Windows-onedir
        path: dist/CarousellUploader/
        retention-days: 30
    
    - name: Check files before release
      if: github.ref == 'refs/heads/main'
      run: |
        echo "Checking build artifacts..."
        if [ -f "dist/CarousellUploader.exe" ]; then
          echo "âœ… CarousellUploader.exe found"
        else
          echo "âŒ CarousellUploader.exe not found"
        fi
        if [ -d "dist/CarousellUploader" ]; then
          echo "âœ… CarousellUploader directory found"
        else
          echo "âŒ CarousellUploader directory not found"
        fi
        ls -la dist/
    
    - name: Create release (onefile)
      if: github.ref == 'refs/heads/main' && (github.event.inputs.build_mode == 'onefile' || github.event.inputs.build_mode == '' || github.event.inputs.build_mode == null)
      uses: softprops/action-gh-release@v1
      with:
        files: dist/CarousellUploader.exe
        tag_name: v${{ github.run_number }}-onefile
        name: Carousell Uploader v${{ github.run_number }} (onefile)
        body: |
          ğŸš€ Carousell Uploader Windows å¯æ‰§è¡Œæ–‡ä»¶ (å•æ–‡ä»¶ç‰ˆæœ¬)
          
          ## ğŸ“¦ æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.run_number }}
          - æ„å»ºæ¨¡å¼: onefile
          - æ“ä½œç³»ç»Ÿ: Windows
          
          ## ğŸ¯ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `CarousellUploader.exe`
          2. ç¡®ä¿ç›®æ ‡æœºå™¨å·²å®‰è£… Microsoft Visual C++ Redistributable
          3. ç›´æ¥è¿è¡Œå³å¯
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create release (onedir)
      if: github.ref == 'refs/heads/main' && github.event.inputs.build_mode == 'onedir'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/CarousellUploader/
        tag_name: v${{ github.run_number }}-onedir
        name: Carousell Uploader v${{ github.run_number }} (onedir)
        body: |
          ğŸš€ Carousell Uploader Windows å¯æ‰§è¡Œæ–‡ä»¶ (å•ç›®å½•ç‰ˆæœ¬)
          
          ## ğŸ“¦ æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.run_number }}
          - æ„å»ºæ¨¡å¼: onedir
          - æ“ä½œç³»ç»Ÿ: Windows
          
          ## ğŸ¯ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `CarousellUploader/` ç›®å½•
          2. ç¡®ä¿ç›®æ ‡æœºå™¨å·²å®‰è£… Microsoft Visual C++ Redistributable
          3. è¿è¡Œç›®å½•ä¸­çš„ `CarousellUploader.exe`
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
